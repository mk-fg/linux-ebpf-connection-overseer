Linux eBPF Connection Overseer
==============================

Network monitoring tool intended to export or display info about both
functioning and blocked network connections, with associated process/cgroup
information, as well as traffic counters on those.

Idea here is to have a minimally intrusive non-interactive window into network
access attempts for systemd cgroups on the machine, to easily spot anything
blocked or unexpected.

It's a work in progress, not supposed to be functional just yet.

Table of Contents

- [Technical details](#hdr-technical_details)
- [Requirements](#hdr-requirements)
- [Links](#hdr-links)

Repository URLs:

- <https://github.com/mk-fg/linux-ebpf-connection-overseer>
- <https://codeberg.org/mk-fg/linux-ebpf-connection-overseer>
- <https://fraggod.net/code/git/linux-ebpf-connection-overseer>


<a name=hdr-technical_details></a>
# Technical details

Intended to consist of several components:

- Self-contained [leco-ebpf-load] binary (mostly generated by `bpftool gen skeleton`),
  that only loads [eBPF] blob into kernel and either stores file descriptors of
  data maps in systemd service [File Descriptor Store], pins those in `/sys/fs/bpf`,
  or no-op exits if it's done already.

    Requires elevated privileges, intended to be run as `ExecStartPre=+...` command.\
    Without pinning, when service stops, fds get closed, which cleans up eBPFs as well.

- Unprivileged [leco-event-pipe] system-daemon python script that uses eBPF map file
  descriptors to monitor for network-related info and export it to some fifo socket as json lines.

    [leco.service] systemd unit file can be used to run loader binary and start this script.

- User session tool to read that json data and visualize in some useful way - not implemented yet.

It's kinda similar to [OpenSnitch] and [netatop-bpf] projects (and is partly based
on those), with simple non-interactive read-only scope, and no extra access beyond
reading data from those eBPF map file descriptors.

[leco-ebpf-load]: loader.c
[eBPF]: https://docs.ebpf.io/
[File Descriptor Store]: https://systemd.io/FILE_DESCRIPTOR_STORE/
[leco-event-pipe]: leco-event-pipe
[leco.service]: leco.service
[OpenSnitch]: https://github.com/evilsocket/opensnitch
[netatop-bpf]: https://github.com/bytedance/netatop-bpf


<a name=hdr-requirements></a>
# Requirements

- [leco-ebpf-load] loader-binary requires [make], [clang] and [llvm] tools,
  as well as kernel headers (e.g. kernel-devel package) to build it.

    Running resulting eBPF-binary on a system needs linux 6.x+,
    with following config opts enabled:

    ``` console
    % bsdcat /proc/config.* | grep -E 'BPF|KPROBE'
    ## Alternatively: grep -E 'BPF|KPROBE' /boot/config-$(uname -r)
    CONFIG_BPF=y
    CONFIG_BPF_SYSCALL=y
    CONFIG_BPF_EVENTS=y
    CONFIG_KPROBES=y
    CONFIG_KPROBE_EVENTS=y
    ```

    Run `git submodule init && git submodule update` first to fetch
    libbpf/bpftool build-dependencies. `make leco-ebpf-load` command
    can be used to build only this `leco-ebpf-load` eBPF-loader binary.

- [leco-event-pipe] script requires [python] (with ctypes) and [libbpf] installed,
  uses fds/pins created by `leco-ebpf-load`, that should be ran before it.

- [leco-sdl-widget] requires [Nim] and [cmake] to build (including its [tinyspline]
  submodule dependency), and only [SDL3] + [SDL3_ttf] (Simple DirectMedia Layer 3.x)
  libraries installed on the system in order to run.

  Will not work with older SDL 1.x and 2.x library branches (different API).

  `git submodule init && git submodule update` needs to be run first
  to fetch tinyspline build dependency library.
  Can be built separately using `make leco-sdl-widget` command.

[make]: https://www.gnu.org/software/make
[clang]: https://clang.llvm.org/
[llvm]: https://llvm.org/

[python]: https://www.python.org/
[libbpf]: https://github.com/libbpf/libbpf

[leco-sdl-widget]: widget.nim
[Nim]: https://nim-lang.org/
[cmake]: https://cmake.org/
[tinyspline]: https://github.com/msteinbeck/tinyspline/
[SDL3]: https://libsdl.org/
[SDL3_ttf]: https://github.com/libsdl-org/SDL_ttf


<a name=hdr-links></a>
# Links

- [OpenSnitch] - GUI for interactive firewall setup when new connections are detected.
- [netatop-bpf] - eBPF-based extension for [atop tool] to display per-process network traffic.
- [Qtap] - much more powerful eBPF network-monitoring "agent" to even monitor encrypted connections.
- [systemd-cgroup-nftables-policy-manager] - user-session cgroup-based firewall configuration helper.
- [cgroup-skb.nonet.c] - very simple eBPF to block per-cgroup egress network access.

[Qtap]: https://qpoint.io/qtap
[atop tool]: https://www.atoptool.nl/
[systemd-cgroup-nftables-policy-manager]:
  https://github.com/mk-fg/systemd-cgroup-nftables-policy-manager
[cgroup-skb.nonet.c]: https://github.com/mk-fg/fgtk/blob/master/bpf/cgroup-skb.nonet.c
