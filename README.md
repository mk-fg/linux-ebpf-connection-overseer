Linux eBPF Connection Overseer
==============================

Network monitoring tool intended to export or display info about both
functioning and blocked network connections, with associated process/cgroup
information, as well as traffic counters on those.

Idea here is to have a minimally intrusive non-interactive window into network
access attempts for systemd cgroups on the machine, to easily spot anything
blocked or unexpected.

It's a work in progress, not supposed to be functional just yet.

Table of Contents

- [Technical details](#hdr-technical_details)
- [Build / Requirements](#hdr-build___requirements)
- [Known limitations and things to improve later]
- [Links](#hdr-links)

Repository URLs:

- <https://github.com/mk-fg/linux-ebpf-connection-overseer>
- <https://codeberg.org/mk-fg/linux-ebpf-connection-overseer>
- <https://fraggod.net/code/git/linux-ebpf-connection-overseer>

[Known limitations and things to improve later]:
  #hdr-known_limitations_and_things_to_improve_later


<a name=hdr-technical_details></a>
# Technical details

Consists of several components:

- Self-contained [leco-ebpf-load] binary (mostly generated by `bpftool gen skeleton`),
  that only loads [eBPF] blob into kernel and either stores file descriptors of
  data maps in systemd service [File Descriptor Store], pins those in `/sys/fs/bpf`,
  or no-op exits if it's done already.

    Requires elevated privileges, intended to be run as `ExecStartPre=+...` command.\
    Without pinning, when service stops, fds get closed, which cleans up eBPFs as well.

- Unprivileged [leco-event-pipe] system-daemon python script that uses eBPF map file
  descriptors to monitor for network-related info and export it to some fifo socket as json lines.

    [leco.service] systemd unit file can be used to run loader binary and start this script.

- Desktop session [leco-sdl-widget] to read that data and visualize in a relatively simple way.

It's kinda similar to [OpenSnitch] and [netatop-bpf] projects (and is partly based
on those), with simple non-interactive read-only scope, conky-like transparent
window/overlay graphical frontend, and privileged access limited to reading data
from eBPF map fds passed to it.

[leco-ebpf-load]: loader.c
[eBPF]: https://docs.ebpf.io/
[File Descriptor Store]: https://systemd.io/FILE_DESCRIPTOR_STORE/
[leco-event-pipe]: leco-event-pipe
[leco.service]: leco.service
[leco-sdl-widget]: widget.nim
[OpenSnitch]: https://github.com/evilsocket/opensnitch
[netatop-bpf]: https://github.com/bytedance/netatop-bpf


<a name=hdr-build___requirements></a>
# Build / Requirements

In short:

- Build-only dependencies/tools: [cmake], [make], [llvm], [clang], [Nim].

- Runtime dependencies: [python], [libbpf], [SDL3], [SDL3_ttf], kernel with eBPF/kprobes enabled.

- Outputs: leco-ebpf-load, leco-event-pipe, leco-sdl-widget, leco-sdl-widget.ini, leco.service

Run `git submodule init && git submodule update && make` to build all output files as-needed.

More specifically:

- [leco-ebpf-load] loader-binary requires [make], [clang] and [llvm] tools,
  as well as kernel headers (e.g. kernel-devel package) to build it.

    Running resulting eBPF-binary on a system needs linux 6.3+,
    with following config options enabled:

    ``` console
    % bsdcat /proc/config.* | grep -E 'CONFIG_(BPF|TRACEPOINTS)='
    ## Alternatively: grep -E 'CONFIG_(BPF|TRACEPOINTS)=' /boot/config-$(uname -r)
    ## Or also: cat /sys/kernel/debug/tracing/events/sock/sock_send_length/format
    CONFIG_BPF=y
    CONFIG_TRACEPOINTS=y
    ```

    (which can be enabled via `BPF_SYSCALL` + `FTRACE` + `KPROBE_EVENTS`)

    Run `git submodule init && git submodule update` first to fetch
    libbpf/bpftool build-dependencies. `make leco-ebpf-load` command
    can be used to build only this `leco-ebpf-load` eBPF-loader binary.

- [leco-event-pipe] script requires [python] (with ctypes) and [libbpf] installed,
  uses fds/pins created by `leco-ebpf-load`, that should be ran before it.

- [leco-sdl-widget] requires [Nim] and [cmake] to build (including its [tinyspline]
  submodule dependency), and only [SDL3] + [SDL3_ttf] (Simple DirectMedia Layer 3.x)
  libraries installed on the system in order to run.

  Will not work with older SDL 1.x and 2.x library branches (different API).

  `git submodule init && git submodule update` needs to be run first
  to fetch tinyspline build dependency library.
  Can be built separately using `make leco-sdl-widget` command.

[cmake]: https://cmake.org/
[make]: https://www.gnu.org/software/make
[clang]: https://clang.llvm.org/
[llvm]: https://llvm.org/
[Nim]: https://nim-lang.org/
[python]: https://www.python.org/
[libbpf]: https://github.com/libbpf/libbpf
[SDL3]: https://libsdl.org/
[SDL3_ttf]: https://github.com/libsdl-org/SDL_ttf
[tinyspline]: https://github.com/msteinbeck/tinyspline/


<a name=hdr-known_limitations_and_things_to_improve_later></a>
## Known limitations and things to improve later

- Finish implementing all the stuff planned from the start.

    - Cgroup information for displayed network connections.
    - Clear distinction for in/out conns (accept/recvmsg vs connect/sendmsg).
    - Check how firewalled conns get handled, make those visually distinctive.
    - Nicer text with an outline.
    - Effects for new/faded connections added back to the list (glow/blur, slide, etc).
    - Configurable aliases and filters for hosts/ports/etc in the output.
    - Fetch DNS/ASN info for addresses via separate API, from e.g. local resolver.
    - Some screenshot and ascii diagram of components in this README.

- Send events from pipe to multiple receivers.

    Coupled with widget-side filtering, should allow to have different overlays
    for different data, or just round-robin events between those based on key hash.

- Add sending of eBPF event info over network sockets (unix, tcp/udp).

    Currently can be done by running socat from fifo to socket and back to fifo,
    but should be easy enough to support in the python script and widget too.


<a name=hdr-links></a>
# Links

- [OpenSnitch] - GUI for interactive firewall setup when new connections are detected.
- [netatop-bpf] - eBPF-based extension for [atop tool] to display per-process network traffic.
- [Qtap] - much more powerful eBPF network-monitoring "agent" to even monitor encrypted connections.
- [systemd-cgroup-nftables-policy-manager] - user-session cgroup-based firewall configuration helper.
- [cgroup-skb.nonet.c] - very simple eBPF to block per-cgroup egress network access.

[Qtap]: https://qpoint.io/qtap
[atop tool]: https://www.atoptool.nl/
[systemd-cgroup-nftables-policy-manager]:
  https://github.com/mk-fg/systemd-cgroup-nftables-policy-manager
[cgroup-skb.nonet.c]: https://github.com/mk-fg/fgtk/blob/master/bpf/cgroup-skb.nonet.c
