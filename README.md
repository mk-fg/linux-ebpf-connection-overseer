Linux eBPF Connection Overseer
==============================

Network monitoring tool intended to export or display info about both
functioning and blocked network connections, with associated process/cgroup
information, as well as traffic counters on those.

Idea here is to have a minimally intrusive non-interactive window into network
access attempts for systemd cgroups on the machine, to easily spot anything
blocked or unexpected.

It's a work in progress, not supposed to be functional just yet.

Table of Contents

- [Technical details](#hdr-technical_details)
- [Requirements](#hdr-requirements)
- [Links](#hdr-links)

Repository URLs:

- <https://github.com/mk-fg/linux-ebpf-connection-overseer>
- <https://codeberg.org/mk-fg/linux-ebpf-connection-overseer>
- <https://fraggod.net/code/git/linux-ebpf-connection-overseer>


<a name=hdr-technical_details></a>
# Technical details

Intended to consist of two components:

- Self-contained [eBPF] binary (mostly generated by `bpftool gen skeleton`),
  that only loads eBPF blob into kernel and either stores file descriptors of
  data maps in systemd service [File Descriptor Store], pins those in `/sys/fs/bpf`,
  or no-op exits if it's done already.

    Requires elevated privileges, intended to be run as `ExecStartPre=+...` command.\
    Without pinning, when service stops, fds get closed, which cleans up eBPFs as well.

- Unprivileged python script that uses eBPF map file descriptors to monitor for
  required data and export it somewhere in a nice way (e.g. warnings or UI overlay).

It's kinda similar to [OpenSnitch] and [netatop-bpf] projects (and is partly based
on those), with simple non-interactive read-only scope, and no extra access beyond
reading data from those eBPF map file descriptors.

[eBPF]: https://docs.ebpf.io/
[File Descriptor Store]: https://systemd.io/FILE_DESCRIPTOR_STORE/
[OpenSnitch]: https://github.com/evilsocket/opensnitch
[netatop-bpf]: https://github.com/bytedance/netatop-bpf


<a name=hdr-requirements></a>
# Requirements

Build requires: make, clang, llvm, and kernel headers (e.g. kernel-devel package).

Running resulting eBPF-binary on a system needs linux 6.x+, with following config opts enabled:
``` console
% bsdcat /proc/config.* | grep -E 'BPF|KPROBE'
## Alternatively: grep -E 'BPF|KPROBE' /boot/config-$(uname -r)
CONFIG_BPF=y
CONFIG_BPF_SYSCALL=y
CONFIG_BPF_EVENTS=y
CONFIG_KPROBES=y
CONFIG_KPROBE_EVENTS=y
```

Run `git submodule init && git submodule update` first to fetch libbpf/bpftool dependencies.\
After that, `make` should produce `leco-ebpf-load` eBPF loader binary.

There's no userspace script and .service file to use it with yet.


<a name=hdr-links></a>
# Links

- [OpenSnitch] - GUI for interactive firewall setup when new connections are detected.
- [netatop-bpf] - eBPF-based extension for [atop tool] to display per-process network traffic.
- [systemd-cgroup-nftables-policy-manager] - user-session cgroup-based firewall configuration helper.
- [cgroup-skb.nonet.c] - very simple eBPF to block per-cgroup egress network access.

[atop tool]: https://www.atoptool.nl/
[systemd-cgroup-nftables-policy-manager]:
  https://github.com/mk-fg/systemd-cgroup-nftables-policy-manager
[cgroup-skb.nonet.c]: https://github.com/mk-fg/fgtk/blob/master/bpf/cgroup-skb.nonet.c
